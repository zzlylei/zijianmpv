name: Auto Update Worker

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *" # æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      update_latest:
        description: 'æ˜¯å¦æ‰‹åŠ¨æ›´æ–° Latest æ­£å¼ç‰ˆï¼Ÿ'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: åˆå§‹åŒ–ä»“åº“
        uses: actions/checkout@v4

      - name: è·å–å½“å‰æœ¬åœ°ç‰ˆæœ¬
        id: get_local_version
        run: |
          if [ -f version.txt ]; then
            LOCAL_VERSION=$(cat version.txt)
          else
            LOCAL_VERSION=""
          fi
          echo "LOCAL_VERSION=$LOCAL_VERSION" >> $GITHUB_ENV

      - name: è·å–æœ€æ–° Pre-release å’Œ Latest
        id: get_release
        run: |
          API_URL="https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases"
          RESPONSE=$(curl -s "$API_URL")

          # æœ€æ–° Pre-release
          PRE_RELEASE_TAG=$(echo "$RESPONSE" | jq -r '.[] | select(.prerelease==true) | .tag_name' | head -n 1)
          PRE_RELEASE_DOWNLOAD=$(echo "$RESPONSE" | jq -r '.[] | select(.prerelease==true) | .assets[] | select(.name=="worker.zip") | .browser_download_url' | head -n 1)

          # æœ€æ–°æ­£å¼ç‰ˆ Latestï¼ˆä»…æé†’ï¼‰
          LATEST_TAG=$(echo "$RESPONSE" | jq -r '.[] | select(.prerelease==false) | .tag_name' | head -n 1)

          echo "PRE_RELEASE_TAG=$PRE_RELEASE_TAG" >> $GITHUB_ENV
          echo "PRE_RELEASE_DOWNLOAD=$PRE_RELEASE_DOWNLOAD" >> $GITHUB_ENV
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

          echo "æœ€æ–° Pre-release: $PRE_RELEASE_TAG"
          echo "æœ€æ–°æ­£å¼ç‰ˆ Latest: $LATEST_TAG (ä»…æé†’)"

      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–° Pre-release
        id: check_update
        run: |
          if [ "$LOCAL_VERSION" = "$PRE_RELEASE_TAG" ]; then
            echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
            echo "å·²ç»æ˜¯æœ€æ–° Pre-release ç‰ˆæœ¬"
          else
            echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
            echo "å‘ç°æ–° Pre-release ç‰ˆæœ¬ $PRE_RELEASE_TAG"
          fi

      - name: æ›´æ–° Pre-release
        if: env.UPDATE_NEEDED == 'true'
        run: |
          shopt -s extglob
          rm -rf !( .git )
          wget -O worker.zip "$PRE_RELEASE_DOWNLOAD"
          unzip -o worker.zip
          rm worker.zip
          echo "$PRE_RELEASE_TAG" > version.txt

      - name: æäº¤ Pre-release æ›´æ–°
        if: env.UPDATE_NEEDED == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥æœ€æ–° Pre-release Workerï¼š${{ env.PRE_RELEASE_TAG }}"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          push_options: --force

      - name: æ‰‹åŠ¨æ›´æ–° Latest
        if: ${{ github.event.inputs.update_latest == 'true' }}
        run: |
          echo "å¼€å§‹æ‰‹åŠ¨æ›´æ–° Latest æ­£å¼ç‰ˆ $LATEST_TAG"
          API_URL="https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases"
          RESPONSE=$(curl -s "$API_URL")
          LATEST_DOWNLOAD=$(echo "$RESPONSE" | jq -r ".[] | select(.tag_name==\"$LATEST_TAG\") | .assets[] | select(.name==\"worker.zip\") | .browser_download_url")
          shopt -s extglob
          rm -rf !( .git )
          wget -O worker.zip "$LATEST_DOWNLOAD"
          unzip -o worker.zip
          rm worker.zip
          echo "$LATEST_TAG" > version.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸ”„ æ‰‹åŠ¨åŒæ­¥ Latest Workerï¼š$LATEST_TAG"
          git push --force
